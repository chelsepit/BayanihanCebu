#!/usr/bin/env sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ” Running Pre-commit checks for Laravel + Vite project..."

# 1ï¸âƒ£ Ensure dependencies are available
if [ ! -d "node_modules" ]; then
  echo "âš ï¸ Skipping JS checks (no node_modules found)"
else
  # 2ï¸âƒ£ Auto-format JS, CSS, and Vue files
  "npx" prettier --write "resources/js" "resources/views"

  # 3ï¸âƒ£ Lint JS files
  "npx" eslint --max-warnings=0 "resources/js" || (echo "âŒ Fix lint errors before committing" && exit 1)
fi

# 4ï¸âƒ£ Run Laravel tests if artisan exists
if [ -f "artisan" ]; then
  echo "ğŸ§ª Running Laravel tests..."
  php artisan test --stop-on-failure || (echo "âŒ Laravel tests failed. Fix before committing." && exit 1)
else
  echo "âš ï¸ No artisan file found â€” skipping Laravel tests"
fi

# 5ï¸âƒ£ Scan for secrets using ggshield
if command -v ggshield >/dev/null 2>&1; then
  echo "ğŸ•µï¸ Running ggshield secret scan (including .env)..."
  ggshield secret scan pre-commit --staged || (echo "âŒ Secret detected! Remove or ignore before committing." && exit 1)
else
  echo "âš ï¸ ggshield not found â€” skipping secret scan"
fi

# 6ï¸âƒ£ Optional: verify that .env file isn't being committed
if git diff --cached --name-only | grep -q "\.env"; then
  echo "ğŸš¨ .env file detected in commit! Remove it before committing."
  exit 1
fi

echo "âœ… All checks passed. Proceeding with commit..."
